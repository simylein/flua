<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="description" content="Signin to your account" />
		<title>Flua signin</title>
		<style>
			.font-sans {
				font-family: ui-sans-serif, system-ui, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
			}
			.box-border {
				box-sizing: border-box;
			}
			.top-0 {
				top: 0px;
			}
			.right-0 {
				right: 0px;
			}
			.absolute {
				position: absolute;
			}
			.min-h-dvh {
				min-height: 100dvh;
			}
			.min-w-28 {
				min-width: 112px;
			}
			.w-full {
				width: 100%;
			}
			.max-w-96 {
				max-width: 384px;
			}
			.flex {
				display: flex;
			}
			.flex-col {
				flex-direction: column;
			}
			.items-center {
				align-items: center;
			}
			.justify-center {
				justify-content: center;
			}
			.gap-2 {
				gap: 8px;
			}
			.m-0 {
				margin: 0px;
			}
			.m-2 {
				margin: 8px;
			}
			.m-4 {
				margin: 16px;
			}
			.mt-1 {
				margin-top: 4px;
			}
			.mt-3 {
				margin-top: 12px;
			}
			.mb-1 {
				margin-bottom: 4px;
			}
			.mb-2 {
				margin-bottom: 8px;
			}
			.p-2 {
				padding: 8px;
			}
			.p-4 {
				padding: 16px;
			}
			.pt-8 {
				padding-top: 32px;
			}
			.px-4 {
				padding-left: 16px;
				padding-right: 16px;
			}
			.px-8 {
				padding-left: 32px;
				padding-right: 32px;
			}
			.py-1 {
				padding-top: 4px;
				padding-bottom: 4px;
			}
			.pb-4 {
				padding-bottom: 16px;
			}
			.border-0 {
				border-width: 0px;
			}
			.text-sm {
				font-size: 14px;
				line-height: 20px;
			}
			.text-base {
				font-size: 16px;
				line-height: 24px;
			}
			.text-3xl {
				font-size: 30px;
				line-height: 36px;
			}
			.font-normal {
				font-weight: 400;
			}
			.font-semibold {
				font-weight: 600;
			}
			.no-underline {
				text-decoration-line: none;
			}
			.text-black {
				color: #000000;
			}
			.text-red-600 {
				color: #dc2626;
			}
			.text-blue-600 {
				color: #2563eb;
			}
			.bg-white {
				background-color: #ffffff;
			}
			.bg-neutral-100 {
				background-color: #f5f5f5;
			}
			.bg-neutral-200 {
				background-color: #e5e5e5;
			}
			.bg-neutral-300 {
				background-color: #d4d4d4;
			}
			.bg-neutral-400 {
				background-color: #a3a3a3;
			}
			.bg-red-200 {
				background-color: #fecaca;
			}
			.bg-amber-200 {
				background-color: #fde68a;
			}
			.bg-green-200 {
				background-color: #bbf7d0;
			}
			.bg-blue-200 {
				background-color: #bfdbfe;
			}
			.bg-blue-300 {
				background-color: #93c5fd;
			}
			.active\:scale-95:active {
				transform: scale(0.95);
			}
			.cursor-pointer {
				cursor: pointer;
			}
			.cursor-not-allowed {
				cursor: not-allowed;
			}
			.cursor-progress {
				cursor: progress;
			}
			.z-10 {
				z-index: 10;
			}
			@media (min-width: 640px) {
				.sm\:m-8 {
					margin: 32px;
				}
			}
			@media (min-width: 768px) {
				.md\:m-4 {
					margin: 16px;
				}
			}
			@media (min-width: 1024px) {
				.lg\:m-16 {
					margin: 64px;
				}
			}
			@media (prefers-color-scheme: dark) {
				.dark\:text-white {
					color: #ffffff;
				}
				.dark\:text-red-400 {
					color: #f87171;
				}
				.dark\:text-blue-400 {
					color: #60a5fa;
				}
				.dark\:bg-black {
					background-color: #000000;
				}
				.dark\:bg-neutral-900 {
					background-color: #171717;
				}
				.dark\:bg-neutral-800 {
					background-color: #262626;
				}
				.dark\:bg-neutral-700 {
					background-color: #404040;
				}
				.dark\:bg-neutral-600 {
					background-color: #525252;
				}
				.dark\:bg-red-800 {
					background-color: #991b1b;
				}
				.dark\:bg-amber-800 {
					background-color: #92400e;
				}
				.dark\:bg-green-800 {
					background-color: #166534;
				}
				.dark\:bg-blue-700 {
					background-color: #1d4ed8;
				}
				.dark\:bg-blue-800 {
					background-color: #1e40af;
				}
			}
		</style>
	</head>
	<body class="font-sans m-0 text-black dark:text-white bg-white dark:bg-black">
		<main class="min-h-dvh flex items-center justify-center">
			<div id="notifications" class="top-0 right-0 absolute m-2 md:m-4"></div>
			<div class="box-border w-full max-w-96 m-4 sm:m-8 lg:m-16 pt-8 px-8 pb-4 bg-neutral-100 dark:bg-neutral-900">
				<form class="flex flex-col items-center" onsubmit="handleSubmit(event)">
					<h1 class="m-0 mb-2 text-3xl font-semibold">Signin</h1>
					<div class="w-full flex flex-col items-start pb-4">
						<label for="username" class="mb-1 text-base font-normal">Username</label>
						<input
							id="username"
							type="text"
							class="box-border w-full p-2 text-sm border-0 text-black dark:text-white bg-neutral-200 dark:bg-neutral-800"
							placeholder="username"
							autofocus
							onchange="setValue('username', event.target.value)"
							onblur="setTouched('username', true)"
						/>
						<p id="username-validation" class="m-0 mt-1 hidden text-red-600 dark:text-red-400"></p>
					</div>
					<div class="w-full flex flex-col items-start pb-4">
						<label for="password" class="mb-1 text-base font-normal">Password</label>
						<input
							id="password"
							type="password"
							class="box-border w-full p-2 text-sm border-0 text-black dark:text-white bg-neutral-200 dark:bg-neutral-800"
							placeholder="password"
							onchange="setValue('password', event.target.value)"
							onblur="setTouched('password', true)"
						/>
						<p id="password-validation" class="m-0 mt-1 hidden text-red-600 dark:text-red-400"></p>
					</div>
					<button
						id="signin-button"
						type="submit"
						class="min-w-28 text-base font-normal py-1 px-4 border-0 text-black dark:text-white bg-blue-300 dark:bg-blue-700 active:scale-95 cursor-pointer"
					>
						Signin
					</button>
					<div class="flex items-center gap-2 mt-3">
						<p class="m-0">Need an account?</p>
						<a href="/signup" class="no-underline text-base font-normal text-blue-600 dark:text-blue-400">signup</a>
					</div>
				</form>
			</div>
		</main>
	</body>
	<script>
		const formik = (elements, schema, submit) => {
			const [values, errors, touched] = [{}, {}, {}];
			const validate = (all) => {
				if (all) Object.keys(schema).forEach((key) => (touched[key] = true));
				Object.keys(touched).forEach((key) => {
					if (touched[key]) errors[key] = schema[key](values[key]);
				});
				Object.keys(errors).forEach((key) => {
					Object.keys(elements)
						.filter((element) => element === key)
						.forEach((element) => {
							if (errors[key]) {
								elements[element].innerText = errors[key];
								elements[element].classList.remove('hidden');
							} else {
								elements[element].innerText = '';
								elements[element].classList.add('hidden');
							}
						});
				});
				const valid = Object.keys(errors).every((key) => !errors[key]);
				if (valid) {
					elements.button.disabled = false;
					elements.button.classList.add('bg-blue-300', 'dark:bg-blue-700', 'active:scale-95', 'cursor-pointer');
					elements.button.classList.remove('bg-neutral-300', 'dark:bg-neutral-700', 'cursor-not-allowed');
				} else if (all) {
					elements.button.disabled = true;
					elements.button.classList.add('bg-neutral-300', 'dark:bg-neutral-700', 'cursor-not-allowed');
					elements.button.classList.remove('bg-blue-300', 'dark:bg-blue-700', 'active:scale-95', 'cursor-pointer');
				}
				return valid;
			};
			const setValue = (key, value) => {
				values[key] = value;
				validate();
			};
			const setTouched = (key, value) => {
				touched[key] = value;
				validate();
			};
			const handleSubmit = async (event) => {
				event.preventDefault();
				if (!validate(true)) return;
				const store = elements.button.innerText;
				elements.button.innerText = 'loading...';
				elements.button.disabled = true;
				elements.button.classList.add('cursor-progress');
				elements.button.classList.remove('active:scale-95', 'cursor-pointer');

				await submit(values);
				elements.button.innerText = store;
				elements.button.disabled = false;
				elements.button.classList.add('active:scale-95', 'cursor-pointer');
				elements.button.classList.remove('cursor-progress');
			};
			return { values, errors, touched, validate, setValue, setTouched, handleSubmit };
		};
		const notifications = document.getElementById('notifications');
		const kind = (type) => {
			switch (type) {
				case 'info':
					return 'Info';
				case 'success':
					return 'Success';
				case 'warning':
					return 'Warning';
				case 'error':
					return 'Error';
			}
		};
		const color = (type) => {
			switch (type) {
				case 'info':
					return ['bg-blue-200', 'dark:bg-blue-800'];
				case 'success':
					return ['bg-green-200', 'dark:bg-green-800'];
				case 'warning':
					return ['bg-amber-200', 'dark:bg-amber-800'];
				case 'error':
					return ['bg-red-200', 'dark:bg-red-800'];
			}
		};
		const duration = (type) => {
			switch (type) {
				case 'info':
					return 4000;
				case 'success':
					return 3000;
				case 'warning':
					return 6000;
				case 'error':
					return 8000;
			}
		};
		const notification = (type, message) => {
			const element = document.createElement('div');
			element.classList.add('p-4', ...color(type), 'z-10');
			const head = document.createElement('h2');
			head.classList.add('m-0', 'mb-1', 'font-semibold');
			const text = document.createElement('p');
			text.classList.add('m-0', 'font-normal');
			element.appendChild(head);
			element.appendChild(text);
			element.children[0].innerText = kind(type);
			element.children[1].innerText = message;
			if (notifications.children.length > 0) {
				notifications.children[0].remove();
			}
			notifications.appendChild(element);
			setTimeout(() => element.remove(), duration(type));
		};
		const { setValue, setTouched, handleSubmit } = formik(
			{
				button: document.getElementById('signin-button'),
				username: document.getElementById('username-validation'),
				password: document.getElementById('password-validation'),
			},
			{
				username: (value) => {
					if (!value) return 'username is required';
					if (value.length < 4) return 'username is too short';
					if (value.length > 16) return 'username is too long';
				},
				password: (value) => {
					if (!value) return 'password is required';
					if (value.length < 8) return 'password is too short';
					if (value.length > 64) return 'password is too long';
				},
			},
			async (values) => {
				const data = new Blob([values.username, '\0', values.password, '\0']);
				try {
					if (window.location.origin.startsWith('http://localhost')) {
						await new Promise((resolve) => setTimeout(resolve, 400 + Math.random() * 800));
						if (Math.random() < 0.1) {
							throw { status: Math.floor(Math.random() * 200) + 400, statusText: 'Develop' };
						}
					}
					const response = await fetch('/api/signin', { method: 'post', body: data, headers: { 'content-type': 'application/octet-stream' } });
					if (response.status >= 200 && response.status <= 299) {
						notification('success', `Successfully signed in as ${values.username}`);
						window.location.href = `/${values.username}`;
						return;
					}
					throw response;
				} catch (err) {
					if (err instanceof TypeError) {
						return notification('info', 'Seems like you might be offline');
					}
					const message = `Request failed with ${err.status ?? 0} ${err.statusText ?? null}`;
					if (err.status < 500) {
						return notification('warning', message);
					}
					return notification('error', message);
				}
			}
		);
	</script>
</html>
