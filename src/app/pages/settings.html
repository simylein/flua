<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="description" content="Profile settings for flight graphs and account management" />
		<title>Profile settings</title>
		<style></style>
	</head>
	<body class="font-sans flex flex-col m-0 text-base leading-none text-black background-white dark:text-white dark:background-black" onload="loadMe();">
		<notifications ref="./src/app/components/notifications.html" />
		<main class="flex flex-col items-center m-4 md:m-6 lg:m-8">
			<div class="w-full max-w-md flex flex-col gap-2 md:gap-3 lg:gap-4">
				<div class="flex flex-col items-start gap-2">
					<a href="/" class="no-underline text-base font-normal text-blue-600 dark:text-blue-400">home</a>
				</div>
				<div class="flex flex-col items-start gap-2">
					<h2 class="m-0 text-base font-normal">Profile visibility</h2>
					<div id="profile-visibility" class="p-1 background-neutral-100 dark:background-neutral-900">
						<button
							class="text-base font-normal pt-1 pr-4 pb-1 pl-4 border-0 text-black dark:text-white background-neutral-200 dark:background-neutral-800 cursor-pointer"
						>
							Private
						</button>
						<button
							class="text-base font-normal pt-1 pr-4 pb-1 pl-4 border-0 text-black dark:text-white background-neutral-200 dark:background-neutral-800 cursor-pointer"
						>
							Friends
						</button>
						<button
							class="text-base font-normal pt-1 pr-4 pb-1 pl-4 border-0 text-black dark:text-white background-neutral-200 dark:background-neutral-800 cursor-pointer"
						>
							Public
						</button>
					</div>
				</div>
				<div class="flex flex-col items-start gap-2">
					<h2 class="m-0 text-base font-normal">Danger zone</h2>
					<div class="flex flex-col sm:flex-row gap-1">
						<button
							class="text-base font-normal pt-1 pr-4 pb-1 pl-4 border-0 text-black dark:text-white background-amber-300 dark:background-amber-700 cursor-pointer"
							onclick="openPurgeDialog()"
						>
							Purge flights
						</button>
						<button
							class="text-base font-normal pt-1 pr-4 pb-1 pl-4 border-0 text-black dark:text-white background-red-300 dark:background-red-700 cursor-pointer"
							onclick="openProfileDialog()"
						>
							Delete profile
						</button>
					</div>
				</div>
			</div>
			<dialog id="private-dialog" class="max-w-96 p-4 border-0 text-black dark:text-white background-neutral-100 dark:background-neutral-900">
				<div class="flex flex-col gap-2">
					<h1 class="m-0 text-xl font-medium">Make profile visibility private?</h1>
					<p class="m-0 text-base font-normal">A private profile can only be viewed by yourself.</p>
					<div class="flex flex-row-reverse justify-start gap-2">
						<button
							class="min-w-28 text-base font-normal pt-1 pr-4 pb-1 pl-4 border-0 text-black dark:text-white background-green-300 dark:background-green-700 outline-none cursor-pointer"
							onclick="handleSubmit(privateDialog.children[0].children[2].children[0], privateDialog.children[0].children[2].children[1], () => patchMe({ visibility: 'private' }), closePrivateDialog)"
						>
							Private
						</button>
						<button
							class="min-w-28 text-base font-normal pt-1 pr-4 pb-1 pl-4 border-0 text-black dark:text-white background-neutral-300 dark:background-neutral-700 outline-none cursor-pointer"
							onclick="closePrivateDialog()"
						>
							Cancel
						</button>
					</div>
				</div>
			</dialog>
			<dialog id="friends-dialog" class="max-w-96 p-4 border-0 text-black dark:text-white background-neutral-100 dark:background-neutral-900">
				<div class="flex flex-col gap-2">
					<h1 class="m-0 text-xl font-medium">Make profile visibility friends?</h1>
					<p class="m-0 text-base font-normal">A friends profile can only be viewed by friends.</p>
					<div class="flex flex-row-reverse justify-start gap-2">
						<button
							class="min-w-28 text-base font-normal pt-1 pr-4 pb-1 pl-4 border-0 text-black dark:text-white background-teal-300 dark:background-teal-700 outline-none cursor-pointer"
							onclick="handleSubmit(friendsDialog.children[0].children[2].children[0], friendsDialog.children[0].children[2].children[1], () => patchMe({ visibility: 'friends' }), closeFriendsDialog)"
						>
							Friends
						</button>
						<button
							class="min-w-28 text-base font-normal pt-1 pr-4 pb-1 pl-4 border-0 text-black dark:text-white background-neutral-300 dark:background-neutral-700 outline-none cursor-pointer"
							onclick="closeFriendsDialog()"
						>
							Cancel
						</button>
					</div>
				</div>
			</dialog>
			<dialog id="public-dialog" class="max-w-96 p-4 border-0 text-black dark:text-white background-neutral-100 dark:background-neutral-900">
				<div class="flex flex-col gap-2">
					<h1 class="m-0 text-xl font-medium">Make profile visibility public?</h1>
					<p class="m-0 text-base font-normal">A public profile can be viewed by anyone.</p>
					<div class="flex flex-row-reverse justify-start gap-2">
						<button
							class="min-w-28 text-base font-normal pt-1 pr-4 pb-1 pl-4 border-0 text-black dark:text-white background-sky-300 dark:background-sky-700 outline-none cursor-pointer"
							onclick="handleSubmit(publicDialog.children[0].children[2].children[0], publicDialog.children[0].children[2].children[1], () => patchMe({ visibility: 'public' }), closePublicDialog)"
						>
							Public
						</button>
						<button
							class="min-w-28 text-base font-normal pt-1 pr-4 pb-1 pl-4 border-0 text-black dark:text-white background-neutral-300 dark:background-neutral-700 outline-none cursor-pointer"
							onclick="closePublicDialog()"
						>
							Cancel
						</button>
					</div>
				</div>
			</dialog>
			<dialog id="purge-dialog" class="max-w-96 p-4 border-0 text-black dark:text-white background-neutral-100 dark:background-neutral-900">
				<div class="flex flex-col gap-2">
					<h1 class="m-0 text-xl font-medium">Purge flights?</h1>
					<p class="m-0 text-base font-normal">Purging your flights will delete your flights from the database.</p>
					<div class="flex flex-row-reverse justify-start gap-2">
						<button
							class="min-w-28 text-base font-normal pt-1 pr-4 pb-1 pl-4 border-0 text-black dark:text-white background-amber-300 dark:background-amber-700 outline-none cursor-pointer"
							onclick="handleSubmit(purgeDialog.children[0].children[2].children[0], purgeDialog.children[0].children[2].children[1], deleteFlights, closePurgeDialog)"
						>
							Purge
						</button>
						<button
							class="min-w-28 text-base font-normal pt-1 pr-4 pb-1 pl-4 border-0 text-black dark:text-white background-neutral-300 dark:background-neutral-700 outline-none cursor-pointer"
							onclick="closePurgeDialog()"
						>
							Cancel
						</button>
					</div>
				</div>
			</dialog>
			<dialog id="delete-dialog" class="max-w-96 p-4 border-0 text-black dark:text-white background-neutral-100 dark:background-neutral-900">
				<div class="flex flex-col gap-2">
					<h1 class="m-0 text-xl font-medium">Delete profile?</h1>
					<p class="m-0 text-base font-normal">Deleting your profile will delete your flights alongside your user from the database.</p>
					<div class="flex flex-row-reverse justify-start gap-2">
						<button
							class="min-w-28 text-base font-normal pt-1 pr-4 pb-1 pl-4 border-0 text-black dark:text-white background-red-300 dark:background-red-700 outline-none cursor-pointer"
							onclick="handleSubmit(deleteDialog.children[0].children[2].children[0], deleteDialog.children[0].children[2].children[1], deleteMe, closeProfileDialog)"
						>
							Delete
						</button>
						<button
							class="min-w-28 text-base font-normal pt-1 pr-4 pb-1 pl-4 border-0 text-black dark:text-white background-neutral-300 dark:background-neutral-700 outline-none cursor-pointer"
							onclick="closeProfileDialog()"
						>
							Cancel
						</button>
					</div>
				</div>
			</dialog>
		</main>
	</body>
	<script>
		import './src/app/scripts/array.js';
		import './src/app/scripts/fetcher.js';
		import './src/app/scripts/fetching.js';
		import './src/app/scripts/report.js';
		import './src/app/scripts/notification.js';
		const me = { retries: 0, reload: null, timeout: null, controller: null, data: null };
		const profileVisibility = document.getElementById('profile-visibility');
		const visibilityColors = [
			['background-green-300', 'dark:background-green-700'],
			['background-teal-300', 'dark:background-teal-700'],
			['background-sky-300', 'dark:background-sky-700'],
		];
		const privateDialog = document.getElementById('private-dialog');
		const friendsDialog = document.getElementById('friends-dialog');
		const publicDialog = document.getElementById('public-dialog');
		const purgeDialog = document.getElementById('purge-dialog');
		const deleteDialog = document.getElementById('delete-dialog');
		const loading = (element, add, remove) => {
			element.disabled = true;
			element.classList.add(...add, 'background-neutral-200', 'dark:background-neutral-800');
			element.classList.remove('background-red-200', 'dark:background-red-800', 'cursor-pointer', ...remove);
		};
		const paint = (element, add, remove, disable, onclick) => {
			element.disabled = false;
			element.classList.add('cursor-pointer', ...add);
			element.classList.remove('background-neutral-200', 'dark:background-neutral-800', ...remove);
			if (disable) {
				element.disabled = true;
				element.classList.remove('cursor-pointer');
			}
			if (onclick !== undefined) {
				element.onclick = onclick;
			}
		};
		const error = (element) => {
			element.disabled = true;
			element.classList.add('background-red-200', 'dark:background-red-800');
			element.classList.remove('background-neutral-200', 'dark:background-neutral-800', 'cursor-pointer');
		};
		const loadingSettings = () => {
			array(profileVisibility.children.length).forEach((ind) => {
				loading(profileVisibility.children[ind], [], ['background-neutral-300', 'dark:background-neutral-700', ...visibilityColors[ind]]);
			});
		};
		const paintSettings = (data) => {
			paint(profileVisibility.children[0], ['background-neutral-300', 'dark:background-neutral-700'], [], false, openPrivateDialog);
			paint(profileVisibility.children[1], ['background-neutral-300', 'dark:background-neutral-700'], [], false, openFriendsDialog);
			paint(profileVisibility.children[2], ['background-neutral-300', 'dark:background-neutral-700'], [], false, openPublicDialog);
			switch (true) {
				case data.visibility === 'private':
					paint(profileVisibility.children[0], visibilityColors[0], ['background-neutral-300', 'dark:background-neutral-700'], true, null);
					break;
				case data.visibility === 'friends':
					paint(profileVisibility.children[1], visibilityColors[1], ['background-neutral-300', 'dark:background-neutral-700'], true, null);
					break;
				case data.visibility === 'public':
					paint(profileVisibility.children[2], visibilityColors[2], ['background-neutral-300', 'dark:background-neutral-700'], true, null);
					break;
			}
		};
		const errorSettings = () => {
			array(profileVisibility.children.length).forEach((ind) => {
				error(profileVisibility.children[ind]);
			});
		};
		const parseMe = async (response) => {
			const buffer = await response.arrayBuffer();
			const data = new DataView(buffer);
			let byteOffset = 0;
			let bitOffset = 0;
			const readBits = (bits) => {
				let value = 0;
				for (let index = 0; index < bits; index++) {
					const byte = data.getUint8(byteOffset);
					const bit = (byte >> (7 - bitOffset)) & 1;
					value = (value << 1) | bit;
					bitOffset++;
					if (bitOffset === 8) {
						byteOffset++;
						bitOffset = 0;
					}
				}
				return value;
			};
			let stage = 0;
			const me = { id: '', username: '' };
			while (stage < 3 && byteOffset < buffer.byteLength) {
				if (stage === 0) {
					const byte = readBits(8);
					me.id += byte.toString(16);
					if (byteOffset === 16) {
						stage = 1;
					}
				}
				if (stage === 1) {
					const byte = readBits(8);
					if (byte !== 0) {
						me.username += String.fromCharCode(byte);
					} else {
						stage = 2;
					}
				}
				if (stage === 2) {
					const byte = readBits(8);
					if (byte === 0) {
						me.visibility = 'private';
					} else if (byte === 1) {
						me.visibility = 'friends';
					} else if (byte === 2) {
						me.visibility = 'public';
					}
					stage = 3;
				}
			}
			return me;
		};
		const loadMe = fetching(
			me,
			(context) => window.requestAnimationFrame(() => loadingSettings()),
			(context) => fetcher('get', '/api/me', null, { controller: context.controller }),
			async (context, response) => (context.data = await parseMe(response)),
			(context) => window.requestAnimationFrame(() => paintSettings(context.data)),
			(context) => window.requestAnimationFrame(() => errorSettings())
		);
		const handleSubmit = async (confirm, cancel, submit, close) => {
			const store = confirm.innerText;
			confirm.innerText = 'loading...';
			confirm.disabled = true;
			confirm.classList.add('cursor-progress');
			confirm.classList.remove('cursor-pointer');
			cancel.disabled = true;
			cancel.classList.add('cursor-progress');
			cancel.classList.remove('cursor-pointer');
			await submit();
			confirm.innerText = store;
			confirm.disabled = false;
			confirm.classList.add('cursor-pointer');
			confirm.classList.remove('cursor-progress');
			cancel.disabled = false;
			cancel.classList.add('cursor-pointer');
			cancel.classList.remove('cursor-progress');
			close();
		};
		const patchMe = async (me) => {
			const buffer = new ArrayBuffer(1);
			const view = new DataView(buffer);
			let visibility = null;
			switch (true) {
				case me.visibility === 'private':
					visibility = 0;
					break;
				case me.visibility === 'friends':
					visibility = 1;
					break;
				case me.visibility === 'public':
					visibility = 2;
					break;
			}
			view.setUint8(0, visibility);
			try {
				if (window.localStorage.getItem('develop')) {
					await new Promise((resolve) => setTimeout(resolve, 400 + Math.random() * 800));
					if (Math.random() < 0.1) {
						throw { status: Math.floor(Math.random() * 200) + 400, statusText: 'Develop' };
					}
				}
				const response = await fetcher('patch', '/api/me', buffer, { headers: { 'content-type': 'application/octet-stream' } });
				notification('success', 'Successfully updated your profile');
				loadMe();
			} catch (err) {
				report(err);
			}
		};
		const deleteFlights = async () => {
			try {
				const response = await fetcher('delete', '/api/flight');
				notification('success', 'Successfully purged your flights');
				window.location.href = '/';
			} catch (err) {
				report(err);
			}
		};
		const deleteMe = async () => {
			try {
				const response = await fetcher('delete', '/api/me');
				notification('success', 'Successfully deleted your profile');
				window.location.href = '/';
			} catch (err) {
				report(err);
			}
		};
		const openPrivateDialog = () => {
			privateDialog.showModal();
		};
		const closePrivateDialog = () => {
			privateDialog.close();
		};
		const openFriendsDialog = () => {
			friendsDialog.showModal();
		};
		const closeFriendsDialog = () => {
			friendsDialog.close();
		};
		const openPublicDialog = () => {
			publicDialog.showModal();
		};
		const closePublicDialog = () => {
			publicDialog.close();
		};
		const openPurgeDialog = () => {
			purgeDialog.showModal();
		};
		const closePurgeDialog = () => {
			purgeDialog.close();
		};
		const openProfileDialog = () => {
			deleteDialog.showModal();
		};
		const closeProfileDialog = () => {
			deleteDialog.close();
		};
	</script>
</html>
